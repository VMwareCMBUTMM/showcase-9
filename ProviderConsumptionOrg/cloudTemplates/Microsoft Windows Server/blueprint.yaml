formatVersion: 2
name: Microsoft Windows Server
description: Deploy Windows 2019 or 2022 Server
version: 1
inputs:
  namespace:
    type: string
    title: Namespace
    $data: /data/namespaces
  vm_name:
    type: string
    title: Virtual Machine Name
    description: Enter a name for the Virtual Machine
    pattern: ^[a-z0-9]([-a-z0-9]*[a-z0-9])?$
  os_version:
    type: string
    title: Virtual Machine Size
    description: Select a Windows Version to deploy
    default: vmi-0bb9bacf190e10474
    oneOf:
      - title: Windows 2019
        const: vmi-04e7813a63a67a8dd
      - title: Windows 2022
        const: vmi-0bb9bacf190e10474
  storageClass:
    type: string
    title: Storage Class
    $data: /data/storageclasses?namespace={{namespace}}
  vm_size:
    type: string
    title: Virtual Machine Size
    description: Select a Virtual Machine Size
    $data: /data/virtualmachineclasses?namespace={{namespace}}
  username:
    type: string
    description: The username you would like to have for the admin account.
    default: demouser
    title: Admin Username
  password:
    type: string
    description: The password you would like to use for the admin account.
    title: Admin Password
    default: VMware1!
    pattern: '[a-z0-9A-Z@#$]+'
    encrypted: true
resources:
  Namespace:
    type: CCI.Supervisor.Namespace
    properties:
      name: ${input.namespace}
      existing: true
  RDP_LB:
    type: CCI.Supervisor.Resource
    properties:
      context: ${resource.Namespace.id}
      manifest:
        apiVersion: vmoperator.vmware.com/v1alpha3
        kind: VirtualMachineService
        metadata:
          name: ${input.vm_name}
        spec:
          selector:
            vm-lb-selector: ${input.vm_name}
          type: LoadBalancer
          ports:
            - name: rdp
              protocol: TCP
              port: 3389
              targetPort: 3389
  VM:
    type: CCI.Supervisor.Resource
    dependsOn:
      - BOOTSTRAP
      - RDP_LB
    properties:
      context: ${resource.Namespace.id}
      manifest:
        apiVersion: vmoperator.vmware.com/v1alpha3
        kind: VirtualMachine
        metadata:
          name: ${input.vm_name}
          labels:
            vm-selector: ${input.vm_name}
            vm-lb-selector: ${input.vm_name}
        spec:
          className: ${input.vm_size}
          imageName: ${input.os_version}
          storageClass: ${input.storageClass}
          powerState: PoweredOn
          network:
            #domainName: showcase.tmm.broadcom.lab
            nameservers:
              - 10.138.241.1
              - 10.138.241.2
            searchDomains:
              - showcase.tmm.broadcom.lab
          bootstrap:
            sysprep:
              sysprep:
                guiUnattended:
                  password:
                    name: ${input.vm_name}-bootstrap-secret
                    key: password
                userData:
                  fullName: Demo User
                  orgName: Broadcom
                identification:
                  joinWorkgroup: demolab
  BOOTSTRAP:
    type: CCI.Supervisor.Resource
    properties:
      context: ${resource.Namespace.id}
      manifest:
        apiVersion: v1
        kind: Secret
        metadata:
          name: ${input.vm_name}-bootstrap-secret
          labels:
            vm-selector: ${input.vm_name}
        stringData:
          password: ${input.password}
